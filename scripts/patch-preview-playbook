#!/usr/bin/env node

'use strict'

const path = require('node:path')
const yaml = require('yaml')
const fs = require('node:fs')
const deepmerge = require('@fastify/deepmerge')

const readYaml = (path) => 
  fs.existsSync(path) && yaml.parse(fs.readFileSync(path).toString())

const playbook = readYaml('antora-playbook.yml')
const diff =     readYaml('antora-playbook.preview.diff.yml') 

function mergeArray(options) {
  return function (target, source) {
    return Array.from(new Set([...target, ...source]))
  }
}

const merge = deepmerge({ mergeArray })

const preview = merge( playbook, diff )

const header = `\######
# WARNING: DO NOT EDIT BY HAND
# (it will get overwritten)
#
# Instead
#
#  * edit antora-playbook.preview.diff.yml with just the *differences* from the main playbook
#  * run scripts/patch-preview-playbook \n\n`

fs.writeFileSync(
  'antora-playbook.preview.yml',
  header + yaml.stringify(preview),
  { encoding: 'utf8' })

