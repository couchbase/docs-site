'use strict'
/* Copyright (c) 2018-2019 OpenDevise, Inc.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

const aggregateContent = require('@antora/content-aggregator')
const buildPlaybook = require('@antora/playbook-builder')
const classifyContent = require('@antora/content-classifier')
const detectUnresolvedXrefs = require('./detect-unresolved-xrefs')
const generateReport = require('./generate-report')
const { resolveConfig: resolveAsciiDocConfig } = require('@antora/asciidoc-loader')

async function generateSite (args, env) {
  const playbook = buildPlaybook(args, env)
  const asciidocConfig = resolveAsciiDocConfig(playbook)
  const contentCatalog = await aggregateContent(playbook).then((aggregate) =>
    classifyContent(playbook, aggregate, asciidocConfig)
  )
  const docsWithUnresolvedXrefs = detectUnresolvedXrefs(contentCatalog, asciidocConfig)
  if (docsWithUnresolvedXrefs.size) {
    console.error(generateReport(docsWithUnresolvedXrefs))
    console.error('\nantora: xref validation failed! See previous report for details.')
    process.exitCode = 1
  }
}

module.exports = generateSite
